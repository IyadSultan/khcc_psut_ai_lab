{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load crispy_forms_tags %}
{% load custom_filters %}
{% load project_tags %}

{% block extra_css %}
<style>
    /* Base styles */
    :root {
        --transition-speed: 0.2s;
    }

    /* Image styles */
    .featured-image {
        max-height: 500px;
        object-fit: cover;
        width: 100%;
    }
    
    .featured-image-container img {
        max-height: 500px;
        width: 100%;
        object-fit: cover;
        transition: transform var(--transition-speed);
    }
    
    .featured-image-container img:hover {
        transform: scale(1.01);
    }

    /* Comment image styles */
    .comment-image {
        max-width: 300px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform var(--transition-speed);
    }
    
    .comment-image:hover {
        transform: scale(1.02);
    }

    /* Card animations */
    .file-card {
        transition: transform var(--transition-speed);
    }
    
    .file-card:hover {
        transform: translateY(-2px);
    }

    /* Tag styles */
    .tag-badge {
        transition: all var(--transition-speed);
        background-color: #f8f9fa;
        color: #212529;
        text-decoration: none;
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        display: inline-block;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .tag-badge:hover {
        background-color: var(--bs-primary);
        color: white;
        text-decoration: none;
    }

    /* Clap button styles */
    .clap-animation {
        animation: clap-jump 0.3s ease;
    }

    @keyframes clap-jump {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .clap-button.active,
    .clap-comment-btn.active {
        background-color: var(--bs-primary);
        color: white;
    }

    .clap-button:hover,
    .clap-comment-btn:hover {
        transform: scale(1.05);
        transition: transform var(--transition-speed);
    }

    /* Comment thread styles */
    .comment-thread {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding-bottom: 1.5rem;
    }

    .comment-thread:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .comment-replies {
        margin-left: 2rem;
        padding-left: 1rem;
        border-left: 2px solid rgba(0,0,0,0.1);
    }

    .reply-form {
        margin-left: 2rem;
        margin-top: 1rem;
        padding: 1rem;
        background-color: rgba(0,0,0,0.02);
        border-radius: 0.5rem;
        display: none;
    }

    /* Modal styles */
    .modal-image {
        max-height: 90vh;
        width: auto;
        margin: 0 auto;
        display: block;
    }

    /* Utility classes */
    .cursor-pointer {
        cursor: pointer;
    }

    .object-fit-cover {
        object-fit: cover;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .comment-replies {
            margin-left: 1rem;
            padding-left: 0.5rem;
        }

        .reply-form {
            margin-left: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Project Header -->
<div class="bg-primary text-white py-5 mb-5">
    <div class="container">
        <h1 class="display-4">{{ project.title }}</h1>
        <p class="lead">{{ project.author.get_full_name|default:project.author.username|truncatechars:200 }}</p>
    </div>
</div>



<!-- Toast Messages -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="actionToast" class="toast" role="alert" aria-live="polite" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<div class="container py-5">
    <div class="row">
        <!-- Main Content Column -->
        <div class="col-lg-8">
            <!-- Project Header Card -->
            <div class="card shadow-sm mb-4">
                {% if project.featured_image %}
                    <div class="featured-image-container position-relative">
                        <img src="{{ project.featured_image.url }}" 
                             alt="{{ project.title }}" 
                             class="featured-image card-img-top cursor-pointer"
                             data-bs-toggle="modal"
                             data-bs-target="#imageModal">
                {% endif %}
                
                <!-- Author Actions - Moved outside of featured_image block -->
                {% if user == project.author %}
                    <div class="position-absolute top-0 end-0 m-3">
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm shadow-sm" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a href="{% url 'projects:edit_project' project.pk %}" class="dropdown-item">
                                        <i class="bi bi-pencil me-2"></i>Edit Project
                                    </a>
                                </li>
                                <li>
                                    <button type="button" 
                                            class="dropdown-item text-danger" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteProjectModal">
                                        <i class="bi bi-trash me-2"></i>Delete Project
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
                
                {% if project.featured_image %}
                    </div>
                {% endif %}
                
                <div class="card-body">
                    <!-- Project Title and Author Info -->
                    <div class="d-flex justify-content-between align-items-start mb-4">
                        <div>
                            <h2 class="mb-2">{{ project.title }}</h2>
                            
                            <!-- Gold Seed Badge and Info -->
                            {% if project.is_gold %}
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="badge bg-warning text-dark d-flex align-items-center gap-1">
                                    <i class="bi bi-trophy-fill"></i> Gold Seed
                                </span>
                                {% if project.token_reward %}
                                <span class="badge bg-info d-flex align-items-center gap-1">
                                    <i class="bi bi-coin"></i> {{ project.token_reward }} Tokens
                                </span>
                                {% endif %}
                                {% if project.gold_goal %}
                                <span class="badge bg-secondary d-flex align-items-center gap-1">
                                    {% if project.gold_goal == 'all' %}
                                        <i class="bi bi-people-fill"></i> All Complete
                                    {% elif project.gold_goal == 'first' %}
                                        <i class="bi bi-lightning-fill"></i> First to Complete
                                    {% else %}
                                        <i class="bi bi-star-fill"></i> Best Solution
                                    {% endif %}
                                </span>
                                {% endif %}
                                {% if project.deadline %}
                                <span class="badge {% if project.can_submit %}bg-success{% else %}bg-danger{% endif %} d-flex align-items-center gap-1">
                                    <i class="bi bi-clock-fill"></i>
                                    {% if project.can_submit %}
                                        Deadline: {{ project.deadline|date:"M d, Y H:i" }}
                                    {% else %}
                                        Submissions Closed
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}

                            <div class="d-flex align-items-center text-muted">
                                <a href="{% url 'projects:user_profile' project.author.username %}" 
                                   class="text-decoration-none text-muted">
                                    <img src="{% if project.author.profile.avatar %}{{ project.author.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ project.author.username }}{% endif %}" 
                                         alt="{{ project.author.username }}" 
                                         class="rounded-circle me-2"
                                         width="32" height="32">
                                    {{ project.author.get_full_name|default:project.author.username }}
                                </a>
                                <span class="mx-2">•</span>
                                <span>{{ project.created_at|naturaltime }}</span>
                                {% if project.updated_at > project.created_at %}
                                    <span class="mx-2">•</span>
                                    <span>Updated {{ project.updated_at|naturaltime }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Project Title and Description -->
                    <div class="project-content mb-4">
                        {{ project.description|linebreaks }}
                    </div>

                    {% if project.is_gold %}
                        <div class="card mb-4 border-warning">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center gap-2">
                                    <i class="bi bi-trophy-fill text-warning"></i>
                                    Gold Seed Challenge
                                </h5>
                                <div class="mb-3">
                                    <strong>Reward:</strong> {{ project.token_reward }} Tokens
                                    <br>
                                    <strong>Goal:</strong> 
                                    {% if project.gold_goal == 'all' %}
                                        All participants who complete the challenge will receive tokens
                                    {% elif project.gold_goal == 'first' %}
                                        First participant to complete the challenge will receive tokens
                                    {% else %}
                                        Best solution will receive tokens
                                    {% endif %}
                                </div>
                                {% if project.can_submit %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted">
                                            <i class="bi bi-clock"></i> 
                                            Deadline: {{ project.deadline|date:"F d, Y H:i" }}
                                        </div>
                                        <a href="{% url 'projects:submit_solution' project.pk %}" 
                                           class="btn btn-warning">
                                            <i class="bi bi-trophy"></i> Submit Solution
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="alert alert-danger mb-0">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        Submissions are now closed for this challenge.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    {% if project.youtube_url %}
                        <div class="mb-4">
                            <div class="ratio ratio-16x9">
                                <iframe 
                                    src="{{ project.get_youtube_embed_url }}"
                                    title="Project Video"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen>
                                </iframe>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Tags Section -->
                    {% if project.tag_list %}
                        <div class="mb-4">
                            {% for tag in project.tag_list %}
                                <a href="{% url 'projects:project_list' %}?tags={{ tag }}" 
                                   class="tag-badge">
                                    <i class="bi bi-tag-fill me-1 small"></i>{{ tag }}
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if project.generated_tags %}
                    <div class="mb-4">
                        {% for tag in project.generated_tags %}
                            <a href="{% url 'projects:project_list' %}?tags={{ tag }}" 
                               class="tag-badge">
                                <i class="bi bi-tag-fill me-1 small"></i>{{ tag }}
                            </a>
                        {% endfor %}
                    </div>
                {% endif %}

                    <!-- Project Files Section -->
                    {% if project.pdf_file or project.additional_files %}
                        <div class="row g-3 mb-4">
                            {% if project.pdf_file %}
                                <div class="col-md-6">
                                    <div class="card h-100 file-card border">
                                        <div class="card-body text-center p-4">
                                            <i class="bi bi-file-pdf text-danger display-5 mb-3"></i>
                                            <h5 class="card-title h6 mb-2">Documentation</h5>
                                            <p class="text-muted small mb-3">
                                                PDF - {{ project.pdf_file.size|filesizeformat }}
                                            </p>
                                            <a href="{{ project.pdf_file.url }}" 
                                               class="btn btn-outline-primary btn-sm" 
                                               download>
                                                <i class="bi bi-download me-1"></i>Download PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}  

                            {% if project.additional_files %}
                                <div class="col-md-6">
                                    <div class="card h-100 file-card border">
                                        <div class="card-body text-center p-4">
                                            <i class="bi bi-file-earmark-zip text-primary display-5 mb-3"></i>
                                            <h5 class="card-title h6 mb-2">Project Files</h5>
                                            <p class="text-muted small mb-3">
                                                {{ project.additional_files.name|split:'/'|last }}
                                                ({{ project.additional_files.size|filesizeformat }})
                                            </p>
                                            <a href="{{ project.additional_files.url }}" 
                                               class="btn btn-outline-primary btn-sm"
                                               download>
                                                <i class="bi bi-download me-1"></i>Download Files
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Action Buttons Section -->
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            {% if project.github_link %}
                                <a href="{{ project.github_link }}" 
                                   target="_blank" 
                                   class="btn btn-dark">
                                    <i class="bi bi-github me-2"></i>View on GitHub
                                </a>
                            {% endif %}
                            
                            {% if user.is_authenticated %}
                                <button id="clap-btn" 
                                        class="btn btn-outline-primary clap-button {% if user_interactions.has_clapped %}active{% endif %}"
                                        data-project-id="{{ project.id }}">
                                    <i class="bi bi-hands-clapping me-1"></i>
                                    <span id="clap-count">{{ project.clap_count }}</span>
                                </button>
                                
                                <button class="btn btn-outline-primary bookmark-btn" 
                                        data-project-id="{{ project.id }}"
                                        {% if user_interactions.bookmark %}data-bookmarked="true"{% endif %}>
                                    <i class="bi bi-bookmark{% if user_interactions.bookmark %}-fill{% endif %}"></i>
                                </button>
                            {% endif %}
                        </div>
                        
                        <!-- Share Button -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown">
                                <i class="bi bi-share me-1"></i>Share
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <button class="dropdown-item copy-link" 
                                            data-url="{{ request.build_absolute_uri }}">
                                        <i class="bi bi-link-45deg me-2"></i>Copy Link
                                    </button>
                                </li>
                                <li>
                                    <a class="dropdown-item" 
                                       href="https://twitter.com/intent/tweet?text={{ project.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" 
                                       target="_blank">
                                        <i class="bi bi-twitter me-2"></i>Share on Twitter
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" 
                                       href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri|urlencode }}&title={{ project.title|urlencode }}" 
                                       target="_blank">
                                        <i class="bi bi-linkedin me-2"></i>Share on LinkedIn
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">Discussion</h4>
                    <span class="badge bg-secondary">{{ project.comments.count }}</span>
                </div>
                
                <div class="card-body">
                    <!-- Comment Form -->
                    {% if user.is_authenticated %}
                        <form method="post" 
                              action="{% url 'projects:project_detail' project.pk %}" 
                              enctype="multipart/form-data" 
                              class="mb-4 comment-form"
                              id="main-comment-form">
                            {% csrf_token %}
                            {{ comment_form|crispy }}
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="form-text">
                                    <i class="bi bi-image me-1"></i>
                                    You can attach an image to your comment
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    Post Comment
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                Please <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">sign in</a> 
                                to join the discussion.
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Comments List -->
                    <div class="comments-list">
                        {% for comment in comments %}
                            <div class="comment-thread" id="comment-{{ comment.id }}">
                                <!-- Parent Comment -->
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <!-- Comment Header -->
                                        <div class="d-flex align-items-start mb-3">
                                            <img src="{% if comment.user.profile.avatar %}{{ comment.user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ comment.user.username }}{% endif %}" 
                                                 alt="{{ comment.user.username }}" 
                                                 class="rounded-circle me-2"
                                                 width="32" height="32">
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <a href="{% url 'projects:user_profile' comment.user.username %}" 
                                                       class="fw-bold text-decoration-none text-dark me-2">
                                                        {{ comment.user.username }}
                                                    </a>
                                                    {% if comment.user == project.author %}
                                                        <span class="badge bg-primary">Author</span>
                                                    {% endif %}
                                                </div>
                                                <div class="text-muted small">
                                                    {{ comment.created_at|naturaltime }}
                                                    {% if comment.updated_at > comment.created_at %}
                                                        • edited {{ comment.updated_at|naturaltime }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Comment Content -->
                                        <div class="comment-content mb-3">
                                            {{ comment.content|linebreaks }}
                                            {% if comment.image %}
                                                <img src="{{ comment.image.url }}" 
                                                     alt="Comment image" 
                                                     class="comment-image mt-2"
                                                     data-bs-toggle="modal"
                                                     data-bs-target="#imageModal"
                                                     data-full-image="{{ comment.image.url }}">
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Comment Actions -->
                                        {% if user.is_authenticated %}
                                            <div class="d-flex gap-2">
                                                <!-- Clap Button -->
                                                <button class="btn btn-sm btn-light clap-comment-btn {% if comment.has_user_clapped %}active{% endif %}"
                                                        data-comment-id="{{ comment.id }}">
                                                    <i class="bi bi-hands-clapping me-1"></i>
                                                    <span class="clap-count">{{ comment.clap_count }}</span>
                                                </button>
                                                
                                                <!-- Reply Button -->
                                                <button class="btn btn-sm btn-light reply-btn" 
                                                        data-comment-id="{{ comment.id }}">
                                                    <i class="bi bi-reply me-1"></i>Reply
                                                </button>
                                                
                                                <!-- Delete Button (for comment author or project author) -->
                                                {% if user == comment.user or user == project.author %}
                                                    <button class="btn btn-sm btn-light text-danger delete-comment-btn" 
                                                            data-comment-id="{{ comment.id }}"
                                                            data-url="{% url 'projects:delete_comment' comment.id %}">
                                                        <i class="bi bi-trash me-1"></i>Delete
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Reply Form -->
                                <div class="reply-form" id="reply-form-{{ comment.id }}">
                                    <form method="post" 
                                          action="{% url 'projects:project_detail' project.pk %}" 
                                          enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        {{ comment_form|crispy }}
                                        <div class="d-flex justify-content-end gap-2 mt-3">
                                            <button type="button" class="btn btn-light cancel-reply">
                                                Cancel
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                Post Reply
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Replies -->
                                {% if comment.replies.exists %}
                                    <div class="comment-replies mt-3">
                                        {% for reply in comment.replies.all %}
                                            <div class="card border-0 bg-light mb-2" id="comment-{{ reply.id }}">
                                                <div class="card-body">
                                                    <!-- Reply Header -->
                                                    <div class="d-flex align-items-start mb-2">
                                                        <img src="{% if reply.user.profile.avatar %}{{ reply.user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ reply.user.username }}{% endif %}" 
                                                             alt="{{ reply.user.username }}" 
                                                             class="rounded-circle me-2"
                                                             width="24" height="24">
                                                        <div>
                                                            <div class="d-flex align-items-center">
                                                                <a href="{% url 'projects:user_profile' reply.user.username %}" 
                                                                   class="fw-bold text-decoration-none text-dark me-2">
                                                                    {{ reply.user.username }}
                                                                </a>
                                                                {% if reply.user == project.author %}
                                                                    <span class="badge bg-primary">Author</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="text-muted small">
                                                                {{ reply.created_at|naturaltime }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Reply Content -->
                                                    <div class="reply-content mb-2">
                                                        {{ reply.content|linebreaks }}
                                                        {% if reply.image %}
                                                            <img src="{{ reply.image.url }}" 
                                                                 alt="Reply image" 
                                                                 class="comment-image mt-2"
                                                                 data-bs-toggle="modal"
                                                                 data-bs-target="#imageModal"
                                                                 data-full-image="{{ reply.image.url }}">
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- Reply Actions -->
                                                    {% if user.is_authenticated %}
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-light clap-comment-btn {% if reply.has_user_clapped %}active{% endif %}"
                                                                    data-comment-id="{{ reply.id }}">
                                                                <i class="bi bi-hands-clapping me-1"></i>
                                                                <span class="clap-count">{{ reply.clap_count }}</span>
                                                            </button>
                                                            
                                                            {% if user == reply.user or user == project.author %}
                                                                <button class="btn btn-sm btn-light text-danger delete-comment-btn" 
                                                                        data-comment-id="{{ reply.id }}"
                                                                        data-url="{% url 'projects:delete_comment' reply.id %}">
                                                                    <i class="bi bi-trash me-1"></i>Delete
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <div class="text-center py-5">
                                <i class="bi bi-chat-dots text-muted display-4"></i>
                                <p class="text-muted mt-3 mb-0">No comments yet. Be the first to share your thoughts!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sticky-sidebar">
                <!-- Project Stats Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Project Statistics</h5>
                        <div class="row g-3">
                            <!-- Claps Stat -->
                            <div class="col-6">
                                <div class="d-flex align-items-start">
                                    <div class="stats-icon rounded p-2 me-3 bg-primary-subtle">
                                        <i class="bi bi-hands-clapping text-primary"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Claps</small>
                                        <span class="fs-5 fw-semibold stats-claps">{{ stats.clap_count }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Comments Stat -->
                            <div class="col-6">
                                <div class="d-flex align-items-start">
                                    <div class="stats-icon rounded p-2 me-3 bg-primary-subtle">
                                        <i class="bi bi-chat-dots text-primary"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Comments</small>
                                        <span class="fs-5 fw-semibold">{{ project.comments.count }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Rating Stat -->
                            <div class="col-6">
                                <div class="d-flex align-items-start">
                                    <div class="stats-icon rounded p-2 me-3 bg-primary-subtle">
                                        <i class="bi bi-star text-primary"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Avg Rating</small>
                                        <span class="fs-5 fw-semibold">{{ project.average_rating|default:"--" }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Views Stat -->
                            <div class="col-6">
                                <div class="d-flex align-items-start">
                                    <div class="stats-icon rounded p-2 me-3 bg-primary-subtle">
                                        <i class="bi bi-eye text-primary"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Views</small>
                                        <span class="fs-5 fw-semibold">{{ stats.view_count|default:"0" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Author Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">About the Author</h5>
                        <div class="d-flex align-items-center mb-3">
                            <img src="{% if project.author.profile.avatar %}{{ project.author.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ project.author.username }}{% endif %}" 
                                 alt="{{ project.author.username }}" 
                                 class="rounded-circle me-3" 
                                 style="width: 64px; height: 64px; object-fit: cover;">
                            <div>
                                <h6 class="mb-1">
                                    <a href="{% url 'projects:user_profile' project.author.username %}" 
                                       class="text-decoration-none text-dark">
                                        {{ project.author.get_full_name|default:project.author.username }}
                                    </a>
                                </h6>
                                {% if project.author.profile.title %}
                                    <p class="text-muted small mb-0">{{ project.author.profile.title }}</p>
                                {% endif %}
                                {% if project.author.profile.department %}
                                    <p class="text-muted small mb-0">{{ project.author.profile.department }}</p>
                                {% endif %}
                            </div>
                        </div>

                        {% if project.author.profile.bio %}
                            <p class="small mb-3">{{ project.author.profile.bio }}</p>
                        {% endif %}

                        {% if project.author.profile.location %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-geo-alt text-muted me-2"></i>
                                <span class="small text-muted">{{ project.author.profile.location }}</span>
                            </div>
                        {% endif %}

                        <!-- Social Links -->
                        <div class="d-flex gap-2 mb-3">
                            {% if project.author.profile.github_username %}
                                <a href="https://github.com/{{ project.author.profile.github_username }}" 
                                   class="btn btn-sm btn-dark" 
                                   target="_blank">
                                    <i class="bi bi-github"></i>
                                </a>
                            {% endif %}
                            
                            {% if project.author.profile.linkedin_url %}
                                <a href="{{ project.author.profile.linkedin_url }}" 
                                   class="btn btn-sm btn-primary" 
                                   target="_blank">
                                    <i class="bi bi-linkedin"></i>
                                </a>
                            {% endif %}

                            {% if project.author.profile.twitter_username %}
                                <a href="https://twitter.com/{{ project.author.profile.twitter_username }}" 
                                   class="btn btn-sm btn-info" 
                                   target="_blank">
                                    <i class="bi bi-twitter text-white"></i>
                                </a>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-between text-muted small">
                            <span>Projects: {{ project.author.projects.count }}</span>
                            <span>Member since: {{ project.author.date_joined|date:"M Y" }}</span>
                        </div>
                    </div>
                </div>

                <!-- Similar Projects Card -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Similar Projects</h5>
                        {% get_similar_projects project as similar_projects %}
                        {% for similar in similar_projects %}
                            <div class="mb-3">
                                <h6 class="mb-1">
                                    <a href="{% url 'projects:project_detail' similar.pk %}" 
                                       class="text-decoration-none">
                                        {{ similar.title }}
                                    </a>
                                </h6>
                                <p class="text-muted small mb-2">
                                    {{ similar.description|truncatechars:100 }}
                                </p>
                                <div class="d-flex justify-content-between align-items-center small">
                                    <div class="d-flex align-items-center">
                                        <img src="{% if similar.author.profile.avatar %}{{ similar.author.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ similar.author.username }}{% endif %}" 
                                             alt="{{ similar.author.username }}" 
                                             class="rounded-circle me-2"
                                             width="20" height="20">
                                        <span class="text-muted">{{ similar.author.username }}</span>
                                    </div>
                                    <span class="text-muted">
                                        {{ similar.created_at|naturaltime }}
                                    </span>
                                </div>
                            </div>
                            {% if not forloop.last %}<hr class="my-3">{% endif %}
                        {% empty %}
                            <p class="text-muted text-center mb-0">No similar projects found</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-body p-0 position-relative">
                <button type="button" 
                        class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                        data-bs-dismiss="modal"></button>
                <img src="" class="img-fluid w-100" id="modalImage" alt="Full size image">
            </div>
        </div>
    </div>
</div>

<!-- Delete Comment Modal -->
<div class="modal fade" id="deleteCommentModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to delete this comment? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteComment">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading fw-bold mb-1">Warning</h6>
                    <p class="mb-0">This action will permanently delete:</p>
                    <ul class="mb-0 mt-2">
                        <li>All project files and images</li>
                        <li>All comments and discussions</li>
                        <li>All analytics data</li>
                        <li>All associated notifications</li>
                    </ul>
                </div>
                <p class="mb-0">Are you sure you want to proceed? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'projects:delete_project' project.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Project</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    $(document).ready(function() {
        // Initialize tooltips
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

        // Initialize toast
        const actionToast = new bootstrap.Toast(document.getElementById('actionToast'));

        // Show toast message function
        function showToast(title, message, delay = 3000) {
            const toast = document.getElementById('actionToast');
            toast.querySelector('#toastTitle').textContent = title;
            toast.querySelector('#toastMessage').textContent = message;
            const bsToast = bootstrap.Toast.getInstance(toast) || new bootstrap.Toast(toast, { delay: delay });
            bsToast.show();
        }

        // Handle clap button for project
        $('#clap-btn').click(function() {
            const btn = $(this);
            const projectId = btn.data('project-id');
            
            $.post("{% url 'projects:clap_project' project.pk %}", {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            })
            .done(function(response) {
                if (response.status === 'success' || response.status === 'removed') {
                    $('#clap-count').text(response.claps);
                    btn.toggleClass('active');
                    
                    // Add animation
                    btn.addClass('clap-animation');
                    setTimeout(() => btn.removeClass('clap-animation'), 300);
                    
                    // Update stats card
                    $('.stats-claps').text(response.claps);
                }
            })
            .fail(function() {
                showToast('Error', 'Failed to update clap. Please try again.');
            });
        });

        // Handle comment claps
        $('.clap-comment-btn').click(function() {
            const btn = $(this);
            const commentId = btn.data('comment-id');
            
            $.post(`/comment/${commentId}/clap/`, {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            })
            .done(function(response) {
                if (response.status === 'success' || response.status === 'removed') {
                    btn.find('.clap-count').text(response.claps);
                    btn.toggleClass('active');
                    
                    // Add animation
                    btn.addClass('clap-animation');
                    setTimeout(() => btn.removeClass('clap-animation'), 300);
                }
            })
            .fail(function() {
                showToast('Error', 'Failed to update clap. Please try again.');
            });
        });

        // Handle reply functionality
        $('.reply-btn').click(function() {
            const commentId = $(this).data('comment-id');
            $('.reply-form').not(`#reply-form-${commentId}`).slideUp();
            $(`#reply-form-${commentId}`).slideToggle();
        });

        $('.cancel-reply').click(function() {
            $(this).closest('.reply-form').slideUp();
        });

        // Handle comment deletion
        let commentToDelete = null;
        let deleteUrl = null;

        $('.delete-comment-btn').click(function() {
            commentToDelete = $(this).data('comment-id');
            deleteUrl = $(this).data('url');
            $('#deleteCommentModal').modal('show');
        });

        $('#confirmDeleteComment').click(function() {
            if (commentToDelete && deleteUrl) {
                $.post(deleteUrl, {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                })
                .done(function(response) {
                    if (response.status === 'success') {
                        $(`#comment-${commentToDelete}`).fadeOut(300, function() {
                            $(this).remove();
                            showToast('Success', 'Comment deleted successfully');
                        });
                    }
                })
                .fail(function() {
                    showToast('Error', 'Failed to delete comment. Please try again.');
                });
                $('#deleteCommentModal').modal('hide');
            }
        });

        // Handle bookmark toggle
        $('.bookmark-btn').click(function() {
            const btn = $(this);
            
            $.post("{% url 'projects:bookmark_project' project.pk %}", {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            })
            .done(function(response) {
                btn.find('i').toggleClass('bi-bookmark bi-bookmark-fill');
                showToast('Success', response.message);
            })
            .fail(function() {
                showToast('Error', 'Failed to update bookmark. Please try again.');
            });
        });

        // Handle image modal
        $('.comment-image').click(function() {
            const fullImage = $(this).data('full-image');
            $('#modalImage').attr('src', fullImage);
        });

        // Handle link copying
        $('.copy-link').click(function() {
            const url = $(this).data('url');
            navigator.clipboard.writeText(url)
                .then(() => showToast('Success', 'Link copied to clipboard!'))
                .catch(() => showToast('Error', 'Failed to copy link. Please try again.'));
        });

        // Smooth scroll to comment if URL has comment ID
        if (window.location.hash && window.location.hash.includes('comment-')) {
            const commentId = window.location.hash;
            $(commentId)[0]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            $(commentId).addClass('bg-light');
            setTimeout(() => $(commentId).removeClass('bg-light'), 2000);
        }
    });
</script>
{% endblock %}



